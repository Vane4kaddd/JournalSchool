<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÖ –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #6a11cb;
            color: white;
            font-family: 'Arial', sans-serif;
            padding: 20px;
            transition: background 0.5s ease;
        }
        .container {
            max-width: 900px;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            color: black;
            transition: background 0.5s ease, color 0.5s ease;
        }
        .wrapper {
            display: flex;
            justify-content: center;
            padding-top: 100px; /* –æ—Ç—Å—Ç—É–ø –æ—Ç –≤–µ—Ä—Ö–Ω–µ–≥–æ –∫—Ä–∞—è, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏ */
        }       
        h2, h3 {
            color: #6a11cb;
            font-weight: bold;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #ccc;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }
        th, td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
            text-align: center;
        }
        th {
            background-color: #6a11cb;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f3f3f3;
        }
        .btn-custom {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            transition: 0.3s;
        }
        .btn-custom:hover {
            background: linear-gradient(135deg, #5210a0, #1b63c8);
            transform: scale(1.05);
        }
        .btn-danger {
            padding: 6px 12px;
            border-radius: 6px;
        }
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: background 0.3s ease;
        }
        .theme-toggle:hover {
            background: #ddd;
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
        body.dark-mode {
            background: #1e1e1e;
            color: white;
        }
        .dark-mode .container {
            background: #2a2a2a;
            color: white;
        }
        .dark-mode h2, .dark-mode h3 {
            color: #a29bfe;
        }
        .dark-mode th {
            background-color: #6c5ce7;
        }
        .dark-mode .btn-custom {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
        }
        .dark-mode .btn-custom:hover {
            background: linear-gradient(135deg, #8e44ad, #5b2c6f);
        }
        .dark-mode .theme-toggle {
            background: #222;
            color: white;
        }
        .btn-green {
            background: linear-gradient(135deg, #28a745, #5cd65c);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 15px;
            border-radius: 8px;
            transition: 0.3s ease;
        }
        .btn-green:hover {
            background: linear-gradient(135deg, #218838, #45c145);
            transform: scale(1.05);
        }

        .btn-gray {
            background: linear-gradient(135deg, #6c757d, #adb5bd);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 15px;
            border-radius: 8px;
            transition: 0.3s ease;
        }
        .btn-gray:hover {
            background: linear-gradient(135deg, #5a6268, #9aa0a6);
            transform: scale(1.05);
        }
        #filesModal .modal-header {
            background-color: #6a11cb; 
            color: white;
            border-bottom: 1px solid rgba(0,0,0,.125);
        }

        .btn-custom.view-files-btn {
            padding: 6px 12px;       
            font-size: 0.875rem;    
            border-radius: 6px;     
            min-width: 70px;         
        }

        .btn-custom.view-files-btn:hover {
            background: linear-gradient(135deg, #5210a0, #1b63c8);
            transform: scale(1.05);
        }

        .btn-warning.btn-sm {
            padding: 6px 12px;
            border-radius: 6px;
            background: #ffc107;
            color: black;
            border: none;
            transition: 0.3s ease;
        }
        .btn-warning.btn-sm:hover {
            background: #e0a800;
            transform: scale(1.05);
        }

        .btn-sm.same-size-btn {
            padding: 6px 12px;
            border-radius: 6px;
            min-width: 90px; /* –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ */
            font-size: 0.875rem;
            text-align: center;
        }
        .btn-danger.dynamic {
            background: linear-gradient(135deg, #dc3545, #ff6b6b);
            color: white;
            border: none;
            padding: 6px 12px;
            font-size: 0.875rem;
            border-radius: 6px;
            min-width: 90px;
            transition: 0.3s ease;
        }
        .btn-danger.dynamic:hover {
            background: linear-gradient(135deg, #b02a37, #ff4d4d);
            transform: scale(1.05);
        }

        td .d-flex form,
        td .d-flex button {
            margin: 0;
            display: inline-block;
        }
        #filesModal .modal-body {
            max-height: 60vh;
            overflow-y: auto;
            padding: 1rem 1.5rem;
            background: #f8f9fa;
            color: #212529;
            border-radius: 0 0 0.3rem 0.3rem;
        }
        @media (max-width: 576px) {
        th.date-due {
            font-size: 14px;        
            letter-spacing: -0.5px; 
            white-space: nowrap;    
        }
        }   
    </style>
</head>
<body>
<div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1100; min-width: 300px;">
  <div id="flash-toast"
       class="toast align-items-center text-white bg-success border-0 shadow"
       role="alert"
       aria-live="assertive"
       aria-atomic="true"
       data-bs-autohide="true"
       data-bs-delay="2000">
    <div class="d-flex">
      <div class="toast-body" id="toast-message">
        <!-- flash-—Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å -->
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
    </div>
  </div>
</div>

<button class="theme-toggle" id="themeToggle">üåô</button>
<!-- –ö–Ω–æ–ø–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<button class="theme-toggle me-3" id="notificationBtn" style="right: 60px;">
  üîî
  {% if unread_count > 0 %}
  <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
      {{ unread_count }}
  </span>
  {% endif %}
</button>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<div class="modal fade" id="notificationModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content bg-white text-dark">
      <div class="modal-header d-flex justify-content-between align-items-center w-100">
        <h5 class="modal-title mb-0">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h5>
        <div class="d-flex align-items-center gap-2">
            <form method="POST" action="{{ url_for('clear_notifications') }}" class="m-0">
                <button type="submit" class="btn btn-sm btn-outline-danger">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </form>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
        </div>
      </div>
      <div class="modal-body">
        {% for note in notifications %}
        <div class="alert alert-{{ 'secondary' if note.is_read else 'primary' }}">
            <small class="text-muted">{{ note.timestamp.strftime('%d.%m.%Y %H:%M') }}</small><br>
            {{ note.message }}
        </div>
        {% else %}
        <p class="text-muted">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.</p>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('notificationBtn').addEventListener('click', function () {
  // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  new bootstrap.Modal(document.getElementById('notificationModal')).show();

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä, —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏
  fetch('/mark_notifications_read', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  });
});
</script>

<div class="wrapper">
    <div class="container">
        <h1 class="mb-4">üìñ –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h1>

        <!-- –§–æ—Ä–º–∞ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã -->
        <form method="GET" action="{{ url_for('homework') }}" class="mb-3">
            <label for="homework_date" class="form-label">üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É:</label>
            <input type="date" name="date" value="{{ selected_date }}" class="form-control" onchange="this.form.submit()" />
        </form>

        <h3 class="mt-4">–ó–∞–¥–∞–Ω–∏—è –Ω–∞ {{ selected_date }}</h3>

        {% if is_teacher or current_user.role == 'student' %}
        <div class="table-responsive mt-3">
            <table class="table">
                <thead>
                    <tr>
                        {% if current_user.role != 'student' %}
                            <th class="date-due">üè´<br>–ö–ª–∞—Å—Å</th>
                        {% endif %}
                        <th class="date-due">üìö<br>–ü—Ä–µ–¥–º–µ—Ç</th>
                        <th class="date-due">üìù<br>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        <th class="date-due">üìÖ<br>–î–∞—Ç–∞ —Å–¥–∞—á–∏</th>
                        {% if is_teacher %}
                            <th class="date-due">üìÅ<br>–§–∞–π–ª—ã</th>
                            <th class="date-due">‚öôÔ∏è<br>–î–µ–π—Å—Ç–≤–∏—è</th>
                        {% else %}
                            {% set has_files = homeworks|selectattr('files')|list|length > 0 %}
                            {% if has_files %}
                                <th class="date-due">üìÅ<br>–§–∞–π–ª—ã</th>
                            {% endif %}
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                {% for hw in homeworks %}
                <tr>
                    {% if current_user.role != 'student' %}
                        <td>{{ hw.school_class.name }}</td>
                    {% endif %}
                    <td>{{ hw.subject }}</td>
                    <td>{{ hw.description }}</td>
                    <td>{{ hw.due_date.strftime('%d.%m.%Y') }}</td>
                    {% if is_teacher %}
                    <td>
                        {% if hw.files_list|length > 0 %}
                            <button class="btn btn-sm btn-custom view-files-btn"
                                data-files='{{ hw.files_list|tojson }}'
                                data-bs-toggle="modal" data-bs-target="#filesModal">–°–º–æ—Ç—Ä–µ—Ç—å</button>
                        {% else %}
                            &mdash;
                        {% endif %}
                    </td>
                    {% if hw.teacher_id == current_user.id %}
                    <td>
                        <div class="d-flex justify-content-center align-items-center gap-2">
                            <form method="POST" action="{{ url_for('homework') }}">
                                <input type="hidden" name="homework_id" value="{{ hw.id }}">
                                <input type="hidden" name="action" value="delete">
                                <button type="submit" class="btn btn-danger dynamic btn-sm same-size-btn">–£–¥–∞–ª–∏—Ç—å</button>
                            </form>

                            <button type="button"
                                    class="btn btn-warning btn-sm same-size-btn"
                                    onclick="editHomework({{ hw.id }}, '{{ hw.subject }}', '{{ hw.description }}', '{{ hw.due_date.strftime('%Y-%m-%d') }}', '{{ hw.class_id }}')">
                                –ò–∑–º–µ–Ω–∏—Ç—å
                            </button>
                        </div>
                    </td>
                    {% else %}
                    <td class="text-muted">‚Äì</td>
                    {% endif %}

                    {% else %}
                        {% if has_files %}
                        <td>
                            {% if hw.files_list|length > 0 %}
                                <button class="btn btn-sm btn-custom view-files-btn" data-files='{{ hw.files_list|tojson }}' data-bs-toggle="modal" data-bs-target="#filesModal">–°–º–æ—Ç—Ä–µ—Ç—å</button>
                            {% else %}
                                &mdash;
                            {% endif %}
                        </td>
                        {% endif %}
                    {% endif %}
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        {% if is_teacher %}
            <h3 class="mt-4">‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h3>
            <form method="POST" action="{{ url_for('homework') }}" enctype="multipart/form-data">
                <input type="hidden" name="homework_id" id="homework_id" value="">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">üè´ –ö–ª–∞—Å—Å:</label>
                        <select name="class_id" class="form-control" required>
                            <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</option>
                            {% for class in classes %}
                            <option value="{{ class.id }}">{{ class.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">üìñ –ü—Ä–µ–¥–º–µ—Ç:</label>
                        {% if current_user.role == 'teacher' %}
                            <select name="subject" id="subject-field" class="form-control" required>
                                <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>
                                {% if current_user.subjects_list %}
                                    {% for subj in current_user.subjects_list %}
                                        <option value="{{ subj }}">{{ subj }}</option>
                                    {% endfor %}
                                {% else %}
                                    <option value="" disabled>–ü—Ä–µ–¥–º–µ—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã</option>
                                {% endif %}
                            </select>
                        {% else %}
                            <input type="text" name="subject" id="subject-field" class="form-control" required />
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">üìù –û–ø–∏—Å–∞–Ω–∏–µ:</label>
                        <input type="text" name="description" class="form-control" required />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">‚è∞ –î–∞—Ç–∞ —Å–¥–∞—á–∏:</label>
                        <input type="date" name="due_date" class="form-control" required />
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">üìé –§–∞–π–ª—ã (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ):</label>
                    <input type="file" name="files" multiple class="form-control" />
                </div>

                <input type="hidden" name="created_at" value="{{ datetime.utcnow() }}" />

                <div class="d-flex justify-content-center align-items-center gap-3 mt-3 flex-wrap">
                    <button type="submit" name="action" id="form-action" value="add" class="btn btn-green">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-gray mb-0">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</a>
                </div>
            </form>
        {% endif %}

        {% if not is_teacher %}
        <div class="text-center mt-4">
            <a href="{{ url_for('dashboard') }}" class="btn btn-gray">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</a>
        </div>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ñ–∞–π–ª–æ–≤ -->
<div class="modal fade" id="filesModal" tabindex="-1" aria-labelledby="filesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filesModalLabel">–§–∞–π–ª—ã –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body" id="filesModalBody">
        <!-- –§–∞–π–ª—ã –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ JS -->
      </div>
    </div>
  </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll('.view-files-btn').forEach(button => {
            button.addEventListener('click', () => {
                const files = JSON.parse(button.getAttribute('data-files'));
                const container = document.getElementById('filesModalBody');
                container.innerHTML = '';

                if (!files || files.length === 0) {
                    container.innerHTML = '<p>–§–∞–π–ª—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</p>';
                    return;
                }

                files.forEach(file => {
                    const fileLink = document.createElement('a');
                    fileLink.href = `/static/${file}`;
                    fileLink.target = '_blank';
                    fileLink.textContent = file.split('/').pop();
                    fileLink.classList.add('d-block', 'mb-2', 'file-link');
                    container.appendChild(fileLink);
                });
            });
        });
    });
</script>

<script>
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;

    function applyTheme(theme) {
        if (theme === "dark") {
            body.classList.add("dark-mode");
            themeToggle.textContent = "‚òÄÔ∏è";
        } else {
            body.classList.remove("dark-mode");
            themeToggle.textContent = "üåô";
        }
    }

    themeToggle.addEventListener("click", function() {
        let currentTheme = body.classList.contains("dark-mode") ? "light" : "dark";
        localStorage.setItem("theme", currentTheme);
        applyTheme(currentTheme);
    });

    const savedTheme = localStorage.getItem("theme") || "light";
    applyTheme(savedTheme);
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const subjectField = document.getElementById("subject-field");
        if (subjectField) {
            const subject = subjectField.dataset.subject;
            if (subject && !subjectField.value) {
                subjectField.value = subject;
            }
        }
    });
</script>

<script>
  function editHomework(id, subject, description, dueDate, classId) {
    document.getElementById('homework_id').value = id;
    document.querySelector('[name="subject"]').value = subject;
    document.querySelector('[name="description"]').value = description;
    document.querySelector('[name="due_date"]').value = dueDate;
    document.querySelector('[name="class_id"]').value = classId;

    document.getElementById('form-action').value = 'edit';
    document.getElementById('form-action').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
  }
</script>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const toastEl = document.getElementById('flash-toast');
        const toastBody = document.getElementById('toast-message');
        const toast = new bootstrap.Toast(toastEl);

        {% for category, message in messages %}
          toastBody.textContent = {{ message|tojson }};
          toastEl.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-primary');

          {% if category == 'success' %}
              toastEl.classList.add('bg-success');
          {% elif category == 'danger' %}
              toastEl.classList.add('bg-danger');
          {% elif category == 'warning' %}
              toastEl.classList.add('bg-warning');
          {% else %}
              toastEl.classList.add('bg-primary');
          {% endif %}

          toast.show();
        {% endfor %}
      });
    </script>
  {% endif %}
{% endwith %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>