{% extends 'base.html' %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å{% endblock %}

{% block content %}
<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div id="flash-container" class="position-fixed top-0 start-50 translate-middle-x mt-3 z-3" style="z-index: 1055; width: auto;">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show text-center shadow" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
        </div>
      {% endfor %}
    </div>

    <!-- –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫—Ä—ã—Ç–∏—è -->
    <script>
      setTimeout(function () {
        const alerts = document.querySelectorAll('#flash-container .alert');
        alerts.forEach((alert) => {
          // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å "show", —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ
          alert.classList.remove('show');
          alert.classList.add('hide');
          // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ Bootstrap (~150ms)
          setTimeout(() => {
            alert.remove();
          }, 500);
        });
      }, 2000);
    </script>
  {% endif %}
{% endwith %}


<div class="container py-4">
    <h2 class="mb-4 text-white">üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
    <style>
        .btn-custom {
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            color: #fff;
            border: none;
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 8px;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 114, 255, 0.3);
        }

        .btn-custom:hover {
            background: linear-gradient(135deg, #0072ff, #00c6ff);
            transform: scale(1.05);
            box-shadow: 0 6px 14px rgba(0, 114, 255, 0.5);
        }

        .btn-outline-secondary {
            transition: all 0.3s ease;
        }

        .btn-outline-secondary:hover {
            background-color: #dee2e6;
            color: #000;
            transform: scale(1.02);
        }

        /* –î–ª—è –∫–Ω–æ–ø–æ–∫ –≤–Ω—É—Ç—Ä–∏ .modal-footer */
        .modal-footer .btn {
            min-width: 130px;
        }
        
        /* –°–∏–Ω—è—è –∫–Ω–æ–ø–∫–∞: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ */
        .btn-edit {
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            color: #fff;
            border: none;
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 8px;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 114, 255, 0.3);
        }

        .btn-edit:hover {
            background: linear-gradient(135deg, #0072ff, #00c6ff);
            transform: scale(1.05);
            box-shadow: 0 6px 14px rgba(0, 114, 255, 0.5);
        }

        /* –ó–µ–ª—ë–Ω–∞—è –∫–Ω–æ–ø–∫–∞: —Å–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è */
        .btn-password {
            background: linear-gradient(135deg, #38ef7d, #11998e);
            color: #fff;
            border: none;
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 8px;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 10px rgba(17, 153, 142, 0.3);
        }

        .btn-password:hover {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            transform: scale(1.05);
            box-shadow: 0 6px 14px rgba(17, 153, 142, 0.5);
        }

        /* –°–µ—Ä–∞—è –∫–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã */
        .btn-outline-secondary {
            transition: all 0.3s ease;
        }

        .btn-outline-secondary:hover {
            background-color: #dee2e6;
            color: #000;
            transform: scale(1.02);
        }

        .modal-footer .btn {
            min-width: 130px;
        }
        .adaptive-text {
            color: #212529; /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç—ë–º–Ω—ã–π */
            transition: color 0.3s ease;
        }

            body.dark-mode .adaptive-text {
            color: #f8f9fa; /* —Å–≤–µ—Ç–ª—ã–π –ø—Ä–∏ —Ç—ë–º–Ω–æ–π —Ç–µ–º–µ */
        }
    </style>

    <div class="card shadow-lg rounded-4 p-4 d-flex flex-md-row flex-column align-items-center justify-content-center gap-4">
        <!-- –§–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="text-center">
            <img src="{{ url_for('static', filename='profile_pics/' ~ current_user.profile_picture) if current_user.profile_picture else 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png' }}"
             alt="User"
             class="rounded-circle"
             style="width: 100px; height: 100px; object-fit: cover;">
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
        <div class="text-md-start text-center">
            <p class="fs-5 mb-2"><strong>–ò–º—è:</strong> {{ current_user.first_name }} {{ current_user.last_name }}</p>
            <p class="fs-5 mb-2">
                <strong>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong>
                {% if current_user.birth_date %}
                    {{ current_user.birth_date.strftime('%d.%m.%Y') }} ({{ current_user.birth_date | calculate_age }})
                {% else %}
                    –ù–µ —É–∫–∞–∑–∞–Ω–æ
                {% endif %}
            </p>


            <p class="fs-5 mb-2"><strong>–†–æ–ª—å:</strong> 
                {% if current_user.role == 'admin' %}
                    <strong>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</strong>
                {% elif current_user.role == 'teacher' %}
                    <strong>–£—á–∏—Ç–µ–ª—å</strong>
                {% elif current_user.role == 'parent' %}
                    <strong>–†–æ–¥–∏—Ç–µ–ª—å</strong>
                {% else %}
                    <strong>–£—á–µ–Ω–∏–∫</strong>
                {% endif %}
            </p>

            {% if current_user.role == 'student' %}
                <p class="fs-5 mb-2"><strong>–ö–ª–∞—Å—Å:</strong> {{ current_user.school_class.name }}</p>
            {% elif current_user.role == 'teacher' %}
                <p class="fs-5 mb-2"><strong>–ü—Ä–µ–¥–º–µ—Ç—ã:</strong> 
                    {% for subj in current_user.subjects_list %}
                        {{ subj }}{% if not loop.last %}, {% endif %}
                    {% else %}
                        –ù–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
                    {% endfor %}
                </p>
            {% endif %}

            <p class="fs-5 mb-2"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ current_user.phone }}</p>

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="d-flex flex-column gap-2 mt-3">
                <a href="{{ url_for('edit_profile') }}" class="btn btn-edit">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</a>
                <button type="button" class="btn btn-password" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                    üîí –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
                </button>
            </div>
        </div>
    </div>
</div>
{% if user.role == 'teacher' %}
<div class="container py-4 mt-5">
    <h2 class="mb-4 text-white d-flex justify-content-between align-items-center">
        üè´ –ö–ª–∞—Å—Å—ã
        <button type="button" class="btn btn-edit btn-sm" data-bs-toggle="modal" data-bs-target="#editClassesModal">
            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        </button>
    </h2>
    
    <div class="card shadow-lg rounded-4 p-4 #fff">
        <div id="classes-list" class="d-flex flex-wrap gap-2">
            {% if teacher_class_ids %}
                {% for class in all_classes %}
                    {% if class.id in teacher_class_ids %}
                        <div class="class-badge shadow-sm rounded-pill px-3 py-1 d-flex align-items-center">
                            <span>{{ class.name }}</span>
                        </div>
                    {% endif %}
                {% endfor %}
            {% else %}
                <p class="adaptive-text">–ù–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤.</p>
            {% endif %}
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div class="modal fade" id="editClassesModal" tabindex="-1" aria-labelledby="editClassesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg rounded-4 p-4 bg-white text-dark">
        <form method="POST" action="{{ url_for('update_teacher_classes') }}">
            <div class="modal-header border-0">
            <h5 class="modal-title fw-bold" id="editClassesModalLabel">–ö–ª–∞—Å—Å—ã</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å—ã, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã –ø—Ä–µ–ø–æ–¥–∞—ë—Ç–µ:</p>
            <div class="list-group">
                {% for class in all_classes %}
                <label class="list-group-item d-flex align-items-center">
                <input 
                    class="form-check-input me-2" 
                    type="checkbox" 
                    name="classes" 
                    value="{{ class.id }}" 
                    {% if class.id in teacher_class_ids %} checked {% endif %}>
                {{ class.name }}
                </label>
                {% endfor %}
            </div>
            </div>
            <div class="modal-footer border-0">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="btn btn-custom">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
        </div>
    </div>
    </div>
</div>

<style>
.class-badge {
    background: linear-gradient(135deg, #005f99, #0080ff);
    color: white;
    font-weight: 600;
    box-shadow: 0 3px 6px rgba(0, 128, 255, 0.4);
    user-select: none;
    transition: transform 0.2s ease, filter 0.3s ease;
    cursor: default;
}

.class-badge:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 12px rgba(0, 128, 255, 0.6);
}

/* –ò–Ω–≤–µ—Ä—Å–∏—è —Ü–≤–µ—Ç–∞ –ø—Ä–∏ —Ç—ë–º–Ω–æ–π —Ç–µ–º–µ */
body.dark-mode .class-badge {
    background: invert(1) hue-rotate(180deg);
}

@media (max-width: 576px) {
    #classes-list {
        justify-content: center !important;
    }
    .class-badge {
        font-size: 0.9rem;
        padding: 6px 12px;
    }
}
</style>
{% endif %}



<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content shadow-lg rounded-4 p-4">
            <form method="POST" action="{{ url_for('change_password') }}">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" id="changePasswordModalLabel">üîí –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                </div>
                <div class="modal-body">
                    <div class="form-floating mb-3">
                        <input type="password" name="current_password" class="form-control" id="currentPassword" placeholder="–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å" required>
                        <label for="currentPassword">–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="password" name="new_password" class="form-control" id="newPassword" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" required>
                        <label for="newPassword">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="password" name="confirm_password" class="form-control" id="confirmPassword" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" required>
                        <label for="confirmPassword">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-custom">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
